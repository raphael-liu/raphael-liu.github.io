<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Raphael Liu">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2023/09/13/lcp 82-万灵之树/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="探险家小扣终于来到了万灵之树前，挑战最后的谜题。 已知小扣拥有足够数量的链接节点和 n 颗幻境宝石，gem[i] 表示第 i颗宝石的数值。现在小扣需要使用这些链接节点和宝石组合成一颗二叉树，其组装规则为： - 链接节点将作为二叉树中的非叶子节点，且每个链接节点必须拥有 2个子节点； - 幻境宝石将作为二叉树中的叶子节点，所有的幻境宝石都必须被使用。 能量首先进入根节点，而后将按如下规则进行移动和记">
<meta property="og:type" content="article">
<meta property="og:title" content="LCP 82-万灵之树">
<meta property="og:url" content="http://example.com/2023/09/13/LCP%2082-%E4%B8%87%E7%81%B5%E4%B9%8B%E6%A0%91/index.html">
<meta property="og:site_name" content="Raphael&#39;s Blog">
<meta property="og:description" content="探险家小扣终于来到了万灵之树前，挑战最后的谜题。 已知小扣拥有足够数量的链接节点和 n 颗幻境宝石，gem[i] 表示第 i颗宝石的数值。现在小扣需要使用这些链接节点和宝石组合成一颗二叉树，其组装规则为： - 链接节点将作为二叉树中的非叶子节点，且每个链接节点必须拥有 2个子节点； - 幻境宝石将作为二叉树中的叶子节点，所有的幻境宝石都必须被使用。 能量首先进入根节点，而后将按如下规则进行移动和记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic.leetcode.cn/1682397079-evMssw-%E4%B8%87%E7%81%B5%20/(1/).gif">
<meta property="article:published_time" content="2023-09-12T16:47:26.000Z">
<meta property="article:modified_time" content="2023-09-13T09:01:06.539Z">
<meta property="article:author" content="Raphael Liu">
<meta property="article:tag" content="algorithm">
<meta property="article:tag" content="HARD">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.leetcode.cn/1682397079-evMssw-%E4%B8%87%E7%81%B5%20/(1/).gif">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-favicon.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-favicon.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/redefine-favicon.svg">
    <!--- Page Info-->
    
    <title>
        
            LCP 82-万灵之树 -
        
        Raphael&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"example.com","root":"/","language":"zh_CN"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"Raphael's Blog","subtitle":{"text":["格物致知","坚持做正确的事情"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"links":{"github":"https://github.com/raphael-liu","email":"raphael@buaa.edu.cn# your email"},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.4.4","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"首页":{"path":"/","icon":"fa-regular fa-house"},"文章":{"path":"/archives","icon":"fa-regular fa-archive"},"关于":{"icon":"fa-regular fa-user","submenus":{"我":"/about/me","Github":"https://github.com/raphael-liu"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":null},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/8/17 11:45:14"};
    Global.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    Global.data_config = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="swup-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="http://example.com/">
                
                Raphael&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        首页
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        文章
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        关于&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/about/me">我
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/raphael-liu">GITHUB
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer w-full absolute top-0 left-0 bg-background-color">
        <ul class="drawer-navbar-list flex flex-col justify-start items-center">
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                首页
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                文章
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                关于&nbsp;<i class="group-hover:rotate-180 transition-transform fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" href="/about/me">我</a>
                            </li>
                        
                            <li class="text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" target="_blank" rel="noopener" href="https://github.com/raphael-liu">GITHUB</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container">
    <div class="article-content-container">

        <div class="article-title">
            
                <h1 class="article-title-regular">LCP 82-万灵之树</h1>
            
            </div>
            
                    
        
        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Raphael Liu</span>
                        
                            <span class="author-label">Lv10</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-09-13 00:47:26</span>
        <span class="mobile">2023-09-13 00:47:26</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-09-13 17:01:06</span>
            <span class="mobile">2023-09-13 17:01:06</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/algorithm/">algorithm</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/HARD/">HARD</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body">
            <p>探险家小扣终于来到了万灵之树前，挑战最后的谜题。 已知小扣拥有足够数量的链接节点和 <code>n</code> 颗幻境宝石，<code>gem[i]</code> 表示第 <code>i</code><br>颗宝石的数值。现在小扣需要使用这些链接节点和宝石组合成一颗二叉树，其组装规则为： - 链接节点将作为二叉树中的非叶子节点，且每个链接节点必须拥有 <code>2</code><br>个子节点； - 幻境宝石将作为二叉树中的叶子节点，所有的幻境宝石都必须被使用。 能量首先进入根节点，而后将按如下规则进行移动和记录： -<br>若能量首次到达该节点时： - 记录数字 <code>1</code>； - 若该节点为叶节点，将额外记录该叶节点的数值； -<br>若存在未到达的子节点，则选取未到达的一个子节点（优先选取左子节点）进入； - 若无子节点或所有子节点均到达过，此时记录<br><code>9</code>，并回到当前节点的父节点（若存在）。 如果最终记下的数依序连接成一个整数 <code>num</code>，满足 num \mod~p&#x3D;target，则视为解开谜题。<br>请问有多少种二叉树的组装方案，可以使得最终记录下的数字可以解开谜题 <strong>注意：</strong> - 两棵结构不同的二叉树，作为不同的组装方案 -<br>两棵结构相同的二叉树且存在某个相同位置处的宝石编号不同，也作为不同的组装方案 - 可能存在数值相同的两颗宝石 <strong>示例 1：</strong> &gt; 输入：<code>gem = [2,3]</code> &gt; <code>p = 100000007</code> &gt; <code>target = 11391299</code> &gt; &gt; 输出：<code>1</code> &gt; &gt; 解释： &gt; 包含 <code>2</code><br>个叶节点的结构只有一种。 &gt; 假设 B、C 节点的值分别为 3、2，对应 target 为 11391299，如下图所示。 &gt; 11391299 %<br>100000007 &#x3D; 11391299，满足条件; &gt; 假设 B、C 节点的值分别为 2、3，对应 target 为 11291399; &gt;<br>11291399 % 100000007 &#x3D; 11291399，不满足条件； &gt; 因此只存在 1 种方案，返回 1 <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://pic.leetcode.cn/1682397079-evMssw-%E4%B8%87%E7%81%B5%20/(1/).gif"
                      alt="万灵
(1).gif"
                >{:height&#x3D;300px}<br><strong>示例 2：</strong> &gt; 输入：<code>gem = [3,21,3]</code> &gt; <code>p = 7</code> &gt; <code>target = 5</code> &gt; &gt; 输出：<code>4</code> &gt; &gt; 解释： 包含<br><code>3</code> 个叶节点树结构有两种，列举如下： 满足条件的组合有四种情况： &gt; 当结构为下图（1）时：叶子节点的值为 [3,3,21] 或<br>[3,3,21]，得到的整数为 <code>11139139912199</code>。 &gt; 当结构为下图（2）时：叶子节点的值为 [21,3,3] 或<br>[21,3,3]，得到的整数为 <code>11219113913999</code>。<br>![image.png](<a class="link"   target="_blank" rel="noopener" href="https://pic.leetcode.cn/1682322894-vfqJIV-" >https://pic.leetcode.cn/1682322894-vfqJIV- <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>image.png){:width&#x3D;500px} <strong>提示：</strong> - <code>1 &lt;= gem.length &lt;= 9</code> - <code>0 &lt;= gem[i] &lt;= 10^9</code> - <code>1 &lt;= p &lt;= 10^9</code>，保证 p 为素数。 - <code>0 &lt;= target &lt; p</code> - 存在 2 组<br><code>gem.length == 9</code> 的用例</p>
<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p><strong>算法一</strong><br>暴力搜索所有方案。我们需要枚举所有包含 n 个叶节点的完整二叉树的形态，以及所有 1 ~ n 的排列。包含 n 个叶节点的完整二叉树的数量为卡特兰数 C_{n-1，而排列有 n! 种可能。使用一些技巧，可以在均摊 O(1) 的时间内计算出每个方案对应的数 \bmod~p 的值，例如使用集合动态规划或精妙的 dfs 写法。</p>
<p>根据斯特林公式，可知渐近复杂度为 C_{n-1}\cdot n!&#x3D;(4^n&#x2F;n^{3&#x2F;2})\cdot (\sqrt{n}\cdot (n&#x2F;e)^n)&#x3D;(4&#x2F;e)^n\cdot n^{n-1。</p>
<p>具体地，n&#x3D;8 时总方案数为 429\cdot 40320&#x3D;17297280，而 n&#x3D;9 时为 1430\cdot 362880&#x3D;518918400，变大了 30 倍。即使在 n&#x3D;8 时有机会优化通过，但这一复杂度增长极快，当 n&#x3D;9 时就难以接受了。</p>
<p>因为目标是对所有满足条件的方案进行计数，所以对这个搜索进行剪枝似乎是困难的，我没有什么好的想法。如果你没有预先估计复杂度就开始写，然后因为沉没成本，又花了很多时间在暴搜的基础上设计剪枝方案或进行常数优化，那你就上钩了。<br><br></p>
<p><strong>算法二</strong><br>正解是复杂度更优的做法。核心思想是使用树的重心进行分治，并使用 meet-in-the-middle 的技巧合并两部分的答案。考虑找到完整二叉树的重心 v (只考虑叶节点的重量，忽略内部节点)。那么或者 v 存在一个儿子 u 满足以 u 为根的子树的叶子数在 [\dfrac{1&#x2F;3}n,\dfrac{1&#x2F;2}n] 范围内，或者以 v 为根的子树的叶子数 \leq \dfrac{2&#x2F;3}n，即 v 上方的连通块的叶子数在 [\dfrac{1&#x2F;3}n,\dfrac{1&#x2F;2}n+1] 范围内。</p>
<p>若为第一种情况，则可以预先搜索出所有以 u 为根，叶子数 \leq \dfrac{1&#x2F;2}n 的完整二叉树以及其中节点所用到的数字集合所对应的答案。还需要将 u 下方的子树缩成一个叶节点，记为变量 x，搜索 u 上方连通块的情况，叶子数 \leq \dfrac{2&#x2F;3}n+1。这部分的结果可以表示成 v_1,x,v_2 依次连接的形式，v_1,v_2 已知。我们同时记录下 v_2 的长度，这样给定 x 的值后就可以计算出整体表示的数。知道上方部分的结果后可以利用逆元解方程，O(1) 算出下方部分应该得到的值 x，用哈希表在下方部分的结果中查找。对第二种情况的处理类似，需要搜索 v 下方叶子数 \leq \dfrac{2&#x2F;3}n 的子树及 v 上方的连通块。一个小细节是需要对树的形态分类讨论，避免重复计数。<br>注：也可以自顶向下地计算 x。第一名的队伍的实现方式很优雅，推荐大家看一下。</p>
<p>总复杂度为 O\left(\sum_{i&#x3D;1}^{2n&#x2F;3}\dfrac{n!}{(n-i)!}\cdot C_{i-1}\right)&#x3D;O\left(c^n\cdot n^{2n&#x2F;3-1.5}\right)，其中常数 c&#x3D;\dfrac{3^{1&#x2F;3}\cdot 4^{2&#x2F;3} }{e^{2&#x2F;3} }\approx 1.866。这个复杂度是比算法一更优的。(比较复杂度时注意最重要的部分，n^{2n&#x2F;3}&lt;n^n.)</p>
<p>具体地，当 n&#x3D;9 时我们只需要对 6 个叶子的完整二叉树进行搜索。可以对切下来作为下方的子树进行如下分类讨论(对以上通用思路作了一点修改，这样常数小一点)：</p>
<ol>
<li>恰有 6 个叶节点。</li>
<li>恰有 5 个叶节点，且它的兄弟子树有 \geq 2 个叶子。</li>
<li>恰有 4 个叶节点，且它的兄弟子树有 3 个叶子。</li>
<li>恰有 4 个叶节点，且它的兄弟子树在它右边并有 4 个叶子。</li>
</ol>
<p>不难验证这样分类是不重不漏的。这对应着上方与下方一共有大约三百万种方案。我们放了标程 15 倍的时限。</p>
<p>注：当模数 p 不为素数时，我们仍然可以通过逆元 + 中国剩余定理反向计算出下方部分应该得到的值 x，从而合并两部分的答案。对于本题，如果想直接使用逆元的话，需要特判 p&#x3D;2 与 p&#x3D;5 这两个与 10 不互质的素数(简单地考虑连成数字的最后一位即可，一定为 9)。考虑到这题已经比较麻烦了，就没有额外增加 p 任意时的思维难度。<br><br></p>
<p><strong>算法三</strong><br>还可以有另一种 meet-in-the-middle 的合并方法。先枚举每种包含 n 个叶节点的完整二叉树的形状 T。在 T 确定下来后，再枚举 \binom{n}{n&#x2F;2 种将数组 a[1..n] 划分成等大小的两半的方案。划分方法确定后，对每一半分别枚举 (\dfrac{n}{2})! 种排列，依序对应到前一半或后一半的叶子上。最后使用 meet-in-the-middle 合并两半的结果。</p>
<p>总复杂度为 O\left(C_{n-1}\cdot \binom{n}{n&#x2F;2}\cdot (\dfrac{n}{2})!\right)&#x3D;O(c_1^n\cdot n^{n&#x2F;2})，其中常数 c_1&#x3D;\dfrac{4\cdot 2^{1&#x2F;2} }{e^{1&#x2F;2} }\approx 3.432。</p>
<p>这个算法的理论渐近复杂度更优，但对于本题数据范围的实际表现不如算法二，不能确保通过(有一些队伍使用了这个方法，需要实现比较好)。具体地，当 n&#x3D;9 时我们需要考虑大约两千万种方案。<br><br></p>
<p><strong>算法四(算法一)</strong><br>暴力优化，返璞归真。虽然我们的预期是没有选手在比赛中使用暴力 AC 本题，不过我出题的时候也花了一些时间试验，发现极致优化的暴力事实上是可以在时限内轻松通过的。<br>(以下均为 C++ 的结果；我对其他语言的常数优化技巧不是很熟，如果其他语言有暴力能过的话欢迎评论告知。注意 python 是不能使用 numpy 的。)</p>
<p>考虑使用集合动态规划实现暴力，这样代码还是挺短的，而且常数会比 dfs 好一些。方法是用一个列表 c_i 表示使用二进制集合 i 代表的宝石能组合出的所有数字。c_i 可以由所有的 c_j 和 c_{i-j 计算出，其中 j\subseteq i 表示左子树中的宝石集合为 j，那么右子树中的宝石集合为 i-j。</p>
<p>我对这个思路的第一版实现跑了 10s，不够快。需要加一些常数优化。列举如下：</p>
<ol>
<li>用数组代替 vector。</li>
<li>注意到整个程序的瓶颈是最后合并大小为 n-1 和 1 的两棵子树(一共有 n 种组合)。这个时候不需要先合并出整棵树可以取到的值再查询，而是直接统计答案，从左子树中枚举一个值，在右子树的列表中查询对应的值。这样会更快。</li>
<li>当我们合并左右子树时，外层循环枚举小子树，内层枚举大子树。这样内层循环会比较并行，可以给之后的优化带来帮助。</li>
<li>加速取模。我一开始试的是 Barrett 约减，不过后来发现 <a class="link"   target="_blank" rel="noopener" href="https://codeforces.com/blog/entry/111566" >这个 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 批量对固定乘数模数进行乘模的技巧会更快。</li>
<li>这个时候速度上已经可以通过了，但会爆内存。我们将大小为 n-1 的子树对应的列表分成两批计算，算完第一批后直接扔掉，这样内存正好卡在 500MB 内。</li>
<li>查询时，枚举一棵子树中的值 v，用逆元算出另一棵子树中需要的值 r_1 和 r_2，这样内层循环中只需要比较操作：<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (uint *J=c[i-j],*end=c[i-j]+c1[i-j];J!=end;++J)ans+=(*J==r1)+(*J==r2)</span><br></pre></td></tr></table></figure></div>
这样写会很快。原则上说，尽量在算式中分离变量，在外层循环把需要的计算进行预处理。<br>(7). 考虑到选手一般不会使用 SIMD，公平起见我也没有尝试指令集的技巧。不过看起来在以上优化过后，目前的写法是挺容易并行的。</li>
</ol>
<p>这样暴力运行的总时间仅为 1s(可进一步优化到 0.6s，不过不太公平)，而我们考虑到一般选手对标算实现的速度，给 C++ 设定的时限为 4s。<br><br></p>
<p>最后放上不同解法的代码实现：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><figcaption><span>[code -std(算法二)]</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">namespace</span> Hash&#123;</span><br><span class="line">	<span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> uint;</span><br><span class="line">	<span class="type">const</span> uint S=<span class="number">16</span>,S1=<span class="number">32</span>-S,M=<span class="number">1996090921</span>;</span><br><span class="line">	<span class="meta">#<span class="keyword">define</span> H(x) ((uint)x*M&gt;&gt;S1)</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">node</span>&#123;<span class="type">int</span> x,y,t;&#125;h[(<span class="number">1</span>&lt;&lt;S)+<span class="number">105</span>];</span><br><span class="line">	<span class="type">int</span> T=<span class="number">1</span>;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">insert</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">		node *p=h+<span class="built_in">H</span>(x);</span><br><span class="line">		<span class="keyword">for</span> (;p-&gt;t==T;++p)</span><br><span class="line">			<span class="keyword">if</span> (p-&gt;x==x)&#123;++p-&gt;y; <span class="keyword">return</span>;&#125;</span><br><span class="line">		p-&gt;t=T; p-&gt;x=x; p-&gt;y=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">find</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (node *p=h+<span class="built_in">H</span>(x);p-&gt;t==T;++p)</span><br><span class="line">			<span class="keyword">if</span> (p-&gt;x==x)<span class="keyword">return</span> p-&gt;y;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">#<span class="keyword">undef</span> H</span></span><br><span class="line">&#125; <span class="keyword">using</span> <span class="keyword">namespace</span> Hash;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pop __builtin_popcount</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">9</span>,M0=<span class="number">205</span>;</span><br><span class="line"><span class="type">int</span> pow10[M0],pinv[M0],l[N],len[<span class="number">1</span>&lt;&lt;N],n,ans,p,r,B;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span>&#123;<span class="type">int</span> v1,v2,l;&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">log10</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;<span class="keyword">return</span> n&lt;<span class="number">10</span>?<span class="number">1</span>:<span class="built_in">log10</span>(n/<span class="number">10</span>)+<span class="number">1</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt; T <span class="title">extend_gcd</span><span class="params">(T a,T b,T &amp;x,T &amp;y)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!b)&#123;x=<span class="number">1</span>;y=<span class="number">0</span>;<span class="keyword">return</span> a;&#125;</span><br><span class="line">	T res=<span class="built_in">extend_gcd</span>(b,a%b,y,x); y-=x*(a/b);</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt; T <span class="title">inv</span><span class="params">(T a,T M)</span></span>&#123;T x,y; <span class="built_in">extend_gcd</span>(a,M,x,y); <span class="keyword">return</span> (x%M+M)%M;&#125;</span><br><span class="line"><span class="function">ll <span class="title">fac</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;ll res=<span class="number">1</span>; <span class="keyword">while</span> (n)res*=n--; <span class="keyword">return</span> res;&#125;</span><br><span class="line"><span class="function">ll <span class="title">C</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> m)</span></span>&#123;ll res=<span class="number">1</span>; <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;++i)res=res*(n-i+<span class="number">1</span>)/i; <span class="keyword">return</span> res;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	vector&lt;<span class="type">int</span>&gt; c[<span class="number">1</span>&lt;&lt;N];</span><br><span class="line">	vector&lt;Node&gt; d[<span class="number">1</span>&lt;&lt;(N+<span class="number">1</span>)];</span><br><span class="line">	<span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> F1,<span class="keyword">class</span> F2,<span class="keyword">class</span> F3&gt;</span></span><br><span class="line"><span class="function">	<span class="type">void</span> <span class="title">calc</span><span class="params">(<span class="type">int</span> t0,F1 f1,F2 f2,F3 f3)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=(<span class="number">1</span>&lt;&lt;n)+<span class="number">1</span>;i&lt;(<span class="number">1</span>&lt;&lt;(n+<span class="number">1</span>));++i)d[i].<span class="built_in">clear</span>();</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>&lt;&lt;n;i&lt;(<span class="number">1</span>&lt;&lt;(n+<span class="number">1</span>));++i)<span class="keyword">if</span> (<span class="built_in">pop</span>(i)&lt;=t0)&#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> j=(i<span class="number">-1</span>)&amp;i,_f2;j&gt;&gt;n;j=(j<span class="number">-1</span>)&amp;i)<span class="keyword">if</span> ((_f2=<span class="built_in">f2</span>(i,j))||<span class="built_in">f1</span>(i,j))</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;t:d[j])&#123;</span><br><span class="line">					<span class="type">int</span> l1=len[j-(<span class="number">1</span>&lt;&lt;n)]-t.l+<span class="number">2</span>*(j&gt;(<span class="number">1</span>&lt;&lt;n));</span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;v2:c[i-j])&#123;</span><br><span class="line">						d[i].<span class="built_in">push_back</span>(&#123;(t.v1+pow10[l1])%p,</span><br><span class="line">							<span class="built_in">int</span>(((ll)t.v2*pow10[len[i-j]+<span class="number">1</span>]+(ll)v2*<span class="number">10</span>+<span class="number">9</span>)%p),t.l+len[i-j]+<span class="number">1</span>&#125;);</span><br><span class="line">						<span class="keyword">if</span> (!_f2)d[i].<span class="built_in">push_back</span>(&#123;<span class="built_in">int</span>((t.v1+pow10[l1+len[i-j]]+(ll)v2*pow10[l1])%p),</span><br><span class="line">							<span class="built_in">int</span>(((ll)t.v2*<span class="number">10</span>+<span class="number">9</span>)%p),t.l+<span class="number">1</span>&#125;);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="type">int</span> j=(<span class="number">1</span>&lt;&lt;(n+<span class="number">1</span>))<span class="number">-1</span>-i; ++T;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">f3</span>(j))<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;v:c[j])<span class="built_in">insert</span>(v);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;t:d[i])ans+=<span class="built_in">find</span>((((ll)r-t.v2-(ll)t.v1*pow10[len[j]+t.l])%p+p)*pinv[t.l]%p);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">treeOfInfiniteSouls</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; a,<span class="type">int</span> p,<span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">		n=a.<span class="built_in">size</span>(); ans=<span class="number">0</span>; B=(n+<span class="number">2</span>)/<span class="number">3</span>; ::p=p; ::r=r;</span><br><span class="line">		<span class="keyword">if</span> (p==<span class="number">2</span>||p==<span class="number">5</span>)<span class="keyword">return</span> p==<span class="number">2</span>&amp;&amp;r==<span class="number">1</span>||p==<span class="number">5</span>&amp;&amp;r==<span class="number">4</span>?<span class="built_in">C</span>((n<span class="number">-1</span>)*<span class="number">2</span>,n<span class="number">-1</span>)/n*<span class="built_in">fac</span>(n):<span class="number">0</span>;</span><br><span class="line">		pow10[<span class="number">0</span>]=<span class="number">1</span>%p; <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;M0;++i)pow10[i]=(ll)pow10[i<span class="number">-1</span>]*<span class="number">10</span>%p;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;M0;++i)pinv[i]=<span class="built_in">inv</span>(pow10[i],p);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;++i)l[i]=<span class="built_in">log10</span>(a[i]);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;(<span class="number">1</span>&lt;&lt;n);++i)&#123;</span><br><span class="line">			len[i]=(<span class="built_in">pop</span>(i)*<span class="number">2</span><span class="number">-1</span>)*<span class="number">2</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">0</span>;j&lt;n;++j)<span class="keyword">if</span> (i&amp;(<span class="number">1</span>&lt;&lt;j))len[i]+=l[j];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;++i)c[<span class="number">1</span>&lt;&lt;i].<span class="built_in">push_back</span>(((ll)a[i]*<span class="number">10</span>+pow10[l[i]+<span class="number">1</span>]+<span class="number">9</span>)%p);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;(<span class="number">1</span>&lt;&lt;n);++i)<span class="keyword">if</span> (<span class="built_in">pop</span>(i)&lt;=B*<span class="number">2</span>)&#123;  <span class="comment">//component below u</span></span><br><span class="line">			<span class="type">int</span> t=pow10[len[i]<span class="number">-1</span>]+<span class="number">9</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> j=(i<span class="number">-1</span>)&amp;i;j;j=(j<span class="number">-1</span>)&amp;i)</span><br><span class="line">				<span class="keyword">if</span> (n==<span class="number">9</span>||<span class="built_in">pop</span>(i)&lt;<span class="built_in">max</span>((n+<span class="number">1</span>)/<span class="number">2</span>,<span class="number">2</span>)||<span class="built_in">max</span>(<span class="built_in">pop</span>(j),<span class="built_in">pop</span>(i-j))&lt;=<span class="built_in">min</span>(B,(n<span class="number">-1</span>)/<span class="number">2</span>))</span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;v1:c[j])&#123;</span><br><span class="line">						ll t1=(ll)v1*pow10[len[i-j]+<span class="number">1</span>]+t;</span><br><span class="line">						<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;v2:c[i-j])c[i].<span class="built_in">push_back</span>(((ll)v2*<span class="number">10</span>+t1)%p);</span><br><span class="line">					&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		d[<span class="number">1</span>&lt;&lt;n].<span class="built_in">push_back</span>(&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;); <span class="comment">//component above u</span></span><br><span class="line">		<span class="keyword">auto</span> yes=[](<span class="type">int</span> x,<span class="type">int</span> y=<span class="number">0</span>)&#123;<span class="keyword">return</span> <span class="number">1</span>;&#125;; <span class="keyword">auto</span> no=[](<span class="type">int</span> x,<span class="type">int</span> y=<span class="number">0</span>)&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;;</span><br><span class="line">		<span class="keyword">if</span> (n==<span class="number">9</span>)</span><br><span class="line">			<span class="built_in">calc</span>(<span class="number">4</span>,yes,no,[](<span class="type">int</span> j)&#123;<span class="keyword">return</span> <span class="built_in">pop</span>(j)!=<span class="number">6</span>;&#125;), <span class="comment">//remove size 6</span></span><br><span class="line">			<span class="built_in">calc</span>(<span class="number">5</span>,[](<span class="type">int</span> i,<span class="type">int</span> j)&#123;<span class="keyword">return</span> j!=(<span class="number">1</span>&lt;&lt;n)||<span class="built_in">pop</span>(i-j)&gt;=<span class="number">2</span>;&#125;, <span class="comment">//remove size 5</span></span><br><span class="line">				 no,[](<span class="type">int</span> j)&#123;<span class="keyword">return</span> <span class="built_in">pop</span>(j)!=<span class="number">5</span>;&#125;),</span><br><span class="line">			<span class="built_in">calc</span>(<span class="number">6</span>,[](<span class="type">int</span> i,<span class="type">int</span> j)&#123;<span class="keyword">return</span> j!=(<span class="number">1</span>&lt;&lt;n)||<span class="built_in">pop</span>(i-j)==<span class="number">3</span>;&#125;, <span class="comment">//remove size 4</span></span><br><span class="line">				 [](<span class="type">int</span> i,<span class="type">int</span> j)&#123;<span class="keyword">return</span> j==(<span class="number">1</span>&lt;&lt;n)&amp;&amp;<span class="built_in">pop</span>(i-j)==<span class="number">4</span>;&#125;,</span><br><span class="line">				 [](<span class="type">int</span> j)&#123;<span class="keyword">return</span> <span class="built_in">pop</span>(j)!=<span class="number">4</span>;&#125;);</span><br><span class="line">		<span class="keyword">else</span> <span class="built_in">calc</span>(n/<span class="number">2</span>+<span class="number">1</span>,yes,[](<span class="type">int</span> i,<span class="type">int</span> j)&#123;<span class="keyword">return</span> n%<span class="number">2</span>==<span class="number">0</span>&amp;&amp;<span class="built_in">pop</span>(j)==<span class="number">1</span>&amp;&amp;<span class="built_in">pop</span>(i-j)==n/<span class="number">2</span>;&#125;,</span><br><span class="line">				 [](<span class="type">int</span> j)&#123;<span class="keyword">return</span> <span class="built_in">pop</span>(j)&lt;(n+<span class="number">1</span>)/<span class="number">2</span>||<span class="built_in">pop</span>(j)&gt;B*<span class="number">2</span>;&#125;);</span><br><span class="line">		<span class="keyword">return</span> ans;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><figcaption><span>[code - 验题人的C++(AC)]</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 算法二</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">int_len</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">10</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">100</span>) <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">1000</span>) <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">10000</span>) <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">100000</span>) <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">1000000</span>) <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">10000000</span>) <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">100000000</span>) <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">1000000000</span>) <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">lowbit</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x &amp; (-x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; mps[<span class="number">520</span>];</span><br><span class="line">    <span class="type">int</span> thislen[<span class="number">520</span>];</span><br><span class="line">    <span class="type">int</span> tens[<span class="number">505</span>];</span><br><span class="line">    <span class="type">int</span> tens_inv[<span class="number">505</span>];</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> C[<span class="number">15</span>];</span><br><span class="line">    <span class="type">int</span> M;</span><br><span class="line">    unordered_set&lt;<span class="type">int</span>&gt; targs[<span class="number">520</span>];</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">modadd</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (x + y &gt;= M ? x + y - M: x + y);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">poww</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>&#123;</span><br><span class="line">        <span class="type">int</span> res = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (b &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (b &amp; <span class="number">1</span>)</span><br><span class="line">                res = <span class="number">1ll</span> * res * a % M;</span><br><span class="line">            a = <span class="number">1ll</span> * a * a % M, b &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">leaf</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> l)</span></span>&#123;</span><br><span class="line">        <span class="type">int</span> tmp = <span class="built_in">modadd</span>(<span class="number">9</span> % M, <span class="number">10ll</span> * x % M);</span><br><span class="line">        tmp = <span class="built_in">modadd</span>(tmp, tens[l + <span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">treeOfInfiniteSouls</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; a, <span class="type">int</span> p, <span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// preprocess</span></span><br><span class="line">        C[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">8</span>; ++i)&#123;</span><br><span class="line">            C[i] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; i; ++j)&#123;</span><br><span class="line">                C[i] += C[j] * C[i - j - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> n = a.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> nhalf = <span class="built_in">max</span>(<span class="number">1</span>, n &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nhalf &amp; <span class="number">1</span>) ++nhalf;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="number">5</span>) nhalf = n;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="number">2</span>)&#123;</span><br><span class="line">            <span class="comment">// do special judge here</span></span><br><span class="line">            <span class="keyword">if</span> (r == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> perm = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt;= n; ++i)&#123;</span><br><span class="line">                perm *= i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> perm * C[n - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        M = p;</span><br><span class="line">        tens[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">500</span>; ++i)</span><br><span class="line">            tens[i] = <span class="number">10ll</span> * tens[i - <span class="number">1</span>] % p;</span><br><span class="line">        tens_inv[<span class="number">1</span>] = <span class="built_in">poww</span>(<span class="number">10</span> % M, M - <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt;= <span class="number">500</span>; ++i)</span><br><span class="line">            tens_inv[i] = <span class="number">1ll</span> * tens_inv[<span class="number">1</span>] * tens_inv[i - <span class="number">1</span>] % p;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(thislen, <span class="number">0</span>, <span class="built_in">sizeof</span>(thislen));</span><br><span class="line">        thislen[<span class="number">0</span>] = <span class="number">-2</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; (<span class="number">1</span> &lt;&lt; n); ++i)&#123;</span><br><span class="line">            <span class="type">int</span> lb = <span class="built_in">lowbit</span>(i);</span><br><span class="line">            thislen[i] = thislen[i - lb] + <span class="built_in">int_len</span>(a[__builtin_ctz(lb)]) + <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// get all half first</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; (<span class="number">1</span> &lt;&lt; n); ++i)&#123;</span><br><span class="line">            <span class="keyword">if</span> (__builtin_popcount(i) &gt; nhalf)&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!(i &amp; (i - <span class="number">1</span>)))&#123;</span><br><span class="line">                <span class="comment">// 2^some</span></span><br><span class="line">                <span class="type">int</span> val = a[__builtin_ctz(i)];</span><br><span class="line">                <span class="type">int</span> l = <span class="built_in">int_len</span>(val);</span><br><span class="line">                mps[i][<span class="built_in">leaf</span>(val, l)] = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = (i - <span class="number">1</span>) &amp; i; j &gt; <span class="number">0</span>; j = (j - <span class="number">1</span>) &amp; i)&#123;</span><br><span class="line">                <span class="type">int</span> k = i - j;</span><br><span class="line">                <span class="comment">// size + 2(2size - 1)</span></span><br><span class="line">                <span class="comment">// int lj = thislen[j] + ((__builtin_popcount(j) &lt;&lt; 2) - 2);</span></span><br><span class="line">                <span class="type">int</span> lj = thislen[j];</span><br><span class="line">                <span class="type">int</span> tenj = tens[lj + <span class="number">1</span>];</span><br><span class="line">                <span class="comment">// int lk = thislen[k] + ((__builtin_popcount(k) &lt;&lt; 2) - 2);</span></span><br><span class="line">                <span class="type">int</span> lk = thislen[k];</span><br><span class="line">                <span class="type">int</span> tenk = tens[lj + lk + <span class="number">1</span>];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; pj: mps[j])&#123;</span><br><span class="line">                    <span class="comment">// pk, pj</span></span><br><span class="line">                    <span class="type">int</span> tmp = <span class="built_in">modadd</span>(<span class="number">9</span> % M, <span class="number">10ll</span> * pj.first % M);</span><br><span class="line">                    tmp = <span class="built_in">modadd</span>(tmp, tenk);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; pk: mps[k])&#123;</span><br><span class="line">                        <span class="type">int</span> tmp2 = <span class="built_in">modadd</span>(tmp, <span class="number">1ll</span> * pk.first * tenj % M);</span><br><span class="line">                        <span class="keyword">auto</span> iter = mps[i].<span class="built_in">find</span>(tmp2);</span><br><span class="line">                        <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">if</span> (iter != mps[i].<span class="built_in">end</span>())&#123;</span><br><span class="line">                            cnt = iter-&gt;second;</span><br><span class="line">                        &#125;</span><br><span class="line">                        mps[i][tmp2] = cnt + pj.second * pk.second;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// survey</span></span><br><span class="line">        targs[(<span class="number">1</span> &lt;&lt; n) - <span class="number">1</span>].<span class="built_in">insert</span>(r);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> q = n; q &gt; nhalf; --q)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="number">1</span> &lt;&lt; n); ++i)&#123;</span><br><span class="line">                <span class="keyword">if</span> (__builtin_popcount(i) != q)&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> j = (i - <span class="number">1</span>) &amp; i; j &gt; <span class="number">0</span>; j = (j - <span class="number">1</span>) &amp; i)&#123;</span><br><span class="line">                    <span class="type">int</span> k = i - j;</span><br><span class="line">                    <span class="type">int</span> jsize = __builtin_popcount(j);</span><br><span class="line">                    <span class="keyword">if</span> (q - jsize &lt;= nhalf)&#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// avoid duplicate enumeration</span></span><br><span class="line">                    <span class="type">bool</span> norep = (jsize == (q - jsize));</span><br><span class="line"></span><br><span class="line">                    <span class="type">int</span> lj = thislen[j];</span><br><span class="line">                    <span class="type">int</span> lk = thislen[k];</span><br><span class="line">                    <span class="type">int</span> tenk = tens[lj + lk + <span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> tg: targs[i])&#123;</span><br><span class="line">                        tg = <span class="built_in">modadd</span>(tg, M - tenk);</span><br><span class="line">                        tg = <span class="built_in">modadd</span>(tg, M - (<span class="number">9</span> % M));</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; pj: mps[j])&#123;</span><br><span class="line">                            <span class="comment">// j as lower part</span></span><br><span class="line">                            <span class="type">int</span> tg1 = <span class="built_in">modadd</span>(tg, M - (<span class="number">10ll</span> * pj.first % M));</span><br><span class="line">                            tg1 = <span class="number">1ll</span> * tg1 * tens_inv[lj + <span class="number">1</span>] % M;</span><br><span class="line">                            targs[k].<span class="built_in">insert</span>(tg1);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// j as higher part</span></span><br><span class="line">                            <span class="keyword">if</span> (!norep)&#123;</span><br><span class="line">                                <span class="type">int</span> tg2 = <span class="built_in">modadd</span>(tg, M - (<span class="number">1ll</span> * pj.first * tens[lk + <span class="number">1</span>] % M));</span><br><span class="line">                                tg2 = <span class="number">1ll</span> * tg2 * tens_inv[<span class="number">1</span>] % M;</span><br><span class="line">                                targs[k].<span class="built_in">insert</span>(tg2);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// stat</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> q = nhalf + <span class="number">1</span>; q &lt;= n; ++q)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="number">1</span> &lt;&lt; n); ++i)&#123;</span><br><span class="line">                <span class="keyword">if</span> (__builtin_popcount(i) != q)&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> j = (i - <span class="number">1</span>) &amp; i; j &gt; <span class="number">0</span>; j = (j - <span class="number">1</span>) &amp; i)&#123;</span><br><span class="line">                    <span class="type">int</span> k = i - j;</span><br><span class="line">                    <span class="type">int</span> jsize = __builtin_popcount(j);</span><br><span class="line">                    <span class="comment">// only enumerate those with &lt;= 1/2 size</span></span><br><span class="line">                    <span class="keyword">if</span> (jsize &gt; (q &gt;&gt; <span class="number">1</span>))&#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// avoid duplicate enumeration</span></span><br><span class="line">                    <span class="type">bool</span> norep = (jsize == (q - jsize));</span><br><span class="line"></span><br><span class="line">                    <span class="type">int</span> lj = thislen[j];</span><br><span class="line">                    <span class="type">int</span> lk = thislen[k];</span><br><span class="line">                    <span class="type">int</span> tenk = tens[lj + lk + <span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> tg: targs[i])&#123;</span><br><span class="line">                        <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">if</span> (mps[i].<span class="built_in">count</span>(tg))&#123;</span><br><span class="line">                            cnt = mps[i][tg];</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="type">int</span> ori_tg = tg;</span><br><span class="line">                        tg = <span class="built_in">modadd</span>(tg, M - tenk);</span><br><span class="line">                        tg = <span class="built_in">modadd</span>(tg, M - (<span class="number">9</span> % M));</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; pj: mps[j])&#123;</span><br><span class="line">                            <span class="comment">// j as lower part</span></span><br><span class="line">                            <span class="type">int</span> tg1 = <span class="built_in">modadd</span>(tg, M - (<span class="number">10ll</span> * pj.first % M));</span><br><span class="line">                            tg1 = <span class="number">1ll</span> * tg1 * tens_inv[lj + <span class="number">1</span>] % M;</span><br><span class="line">                            <span class="keyword">auto</span> iter = mps[k].<span class="built_in">find</span>(tg1);</span><br><span class="line">                            <span class="keyword">if</span> (iter != mps[k].<span class="built_in">end</span>())&#123;</span><br><span class="line">                                cnt += (iter-&gt;second) * pj.second;</span><br><span class="line">                            &#125;</span><br><span class="line">                            </span><br><span class="line">                            <span class="keyword">if</span> (!norep)&#123;</span><br><span class="line">                                <span class="comment">// j as higher part</span></span><br><span class="line">                                <span class="type">int</span> tg2 = <span class="built_in">modadd</span>(tg, M - (<span class="number">1ll</span> * pj.first * tens[lk + <span class="number">1</span>] % M));</span><br><span class="line">                                tg2 = <span class="number">1ll</span> * tg2 * tens_inv[<span class="number">1</span>] % M;</span><br><span class="line">                                <span class="keyword">auto</span> iter = mps[k].<span class="built_in">find</span>(tg2);</span><br><span class="line">                                <span class="keyword">if</span> (iter != mps[k].<span class="built_in">end</span>())&#123;</span><br><span class="line">                                    cnt += (iter-&gt;second) * pj.second;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        mps[i][ori_tg] = cnt;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">auto</span> iter = mps[(<span class="number">1</span> &lt;&lt; n) - <span class="number">1</span>].<span class="built_in">find</span>(r);</span><br><span class="line">        <span class="keyword">if</span> (iter != mps[(<span class="number">1</span> &lt;&lt; n) - <span class="number">1</span>].<span class="built_in">end</span>())&#123;</span><br><span class="line">            ans += iter-&gt;second;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><figcaption><span>[code - 暴力优化(AC)]</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> uint;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> __int128 u128;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pop __builtin_popcount</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">10</span>,M=<span class="number">205</span>;</span><br><span class="line"><span class="type">int</span> pow10[M],pinv[M],l[N],len[<span class="number">1</span>&lt;&lt;N],t1,p10[<span class="number">1</span>&lt;&lt;N],p10_[<span class="number">1</span>&lt;&lt;N];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">log10</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;<span class="keyword">return</span> n&lt;<span class="number">10</span>?<span class="number">1</span>:<span class="built_in">log10</span>(n/<span class="number">10</span>)+<span class="number">1</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt; T <span class="title">extend_gcd</span><span class="params">(T a,T b,T &amp;x,T &amp;y)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!b)&#123;x=<span class="number">1</span>;y=<span class="number">0</span>;<span class="keyword">return</span> a;&#125;</span><br><span class="line">	T res=<span class="built_in">extend_gcd</span>(b,a%b,y,x); y-=x*(a/b);</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt; T <span class="title">inv</span><span class="params">(T a,T M)</span></span>&#123;T x,y; <span class="built_in">extend_gcd</span>(a,M,x,y); <span class="keyword">return</span> (x%M+M)%M;&#125;</span><br><span class="line"><span class="function">ll <span class="title">fac</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;ll res=<span class="number">1</span>; <span class="keyword">while</span> (n)res*=n--; <span class="keyword">return</span> res;&#125;</span><br><span class="line"><span class="function">ll <span class="title">C</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> m)</span></span>&#123;ll res=<span class="number">1</span>; <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;++i)res=res*(n-i+<span class="number">1</span>)/i; <span class="keyword">return</span> res;&#125;</span><br><span class="line">uint _Pool[<span class="number">200000005</span>],*p1,*c[<span class="number">1</span>&lt;&lt;N],c1[<span class="number">1</span>&lt;&lt;N],*pend;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">//__attribute__((no_sanitize_address,no_sanitize_memory))</span></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">treeOfInfiniteSouls</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; a,<span class="type">int</span> p,<span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">		<span class="type">int</span> n=a.<span class="built_in">size</span>(); uint ans=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (p==<span class="number">2</span>||p==<span class="number">5</span>)<span class="keyword">return</span> p==<span class="number">2</span>&amp;&amp;r==<span class="number">1</span>||p==<span class="number">5</span>&amp;&amp;r==<span class="number">4</span>?<span class="built_in">C</span>((n<span class="number">-1</span>)*<span class="number">2</span>,n<span class="number">-1</span>)/n*<span class="built_in">fac</span>(n):<span class="number">0</span>;</span><br><span class="line">		<span class="comment">//if (n==9&amp;&amp;p==2)return 518918400;</span></span><br><span class="line">		<span class="comment">//if (n==9&amp;&amp;p==100000007)return 21;</span></span><br><span class="line">		pow10[<span class="number">0</span>]=<span class="number">1</span>%p; <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;M;++i)pow10[i]=(ll)pow10[i<span class="number">-1</span>]*<span class="number">10</span>%p;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;M;++i)pinv[i]=<span class="built_in">inv</span>(pow10[i],p);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;++i)l[i]=<span class="built_in">log10</span>(a[i]);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;(<span class="number">1</span>&lt;&lt;n);++i)&#123;</span><br><span class="line">			len[i]=(<span class="built_in">pop</span>(i)*<span class="number">2</span><span class="number">-1</span>)*<span class="number">2</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">0</span>;j&lt;n;++j)<span class="keyword">if</span> (i&amp;(<span class="number">1</span>&lt;&lt;j))len[i]+=l[j];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;(<span class="number">1</span>&lt;&lt;n);++i)p10[i]=pow10[len[i]<span class="number">-1</span>],p10_[i]=pow10[len[i]+<span class="number">1</span>];</span><br><span class="line">		ull P1=(((u128)<span class="number">10</span>&lt;&lt;<span class="number">64</span>)+p<span class="number">-1</span>)/p;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> I=<span class="number">0</span>;I&lt;=<span class="number">1</span>;++I)&#123;</span><br><span class="line">			<span class="keyword">if</span> (n&lt;<span class="number">9</span>&amp;&amp;I)<span class="keyword">break</span>;</span><br><span class="line">			p1=!I?_Pool:pend;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;++i)&#123;</span><br><span class="line">				c[<span class="number">1</span>&lt;&lt;i]=p1++; c1[<span class="number">1</span>&lt;&lt;i]=<span class="number">1</span>;</span><br><span class="line">				c[<span class="number">1</span>&lt;&lt;i][<span class="number">0</span>]=((ll)a[i]*<span class="number">10</span>+pow10[l[i]+<span class="number">1</span>]+<span class="number">9</span>)%p;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (n==<span class="number">1</span>)<span class="keyword">return</span> c[<span class="number">1</span>][<span class="number">0</span>]==r;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> K=<span class="number">2</span>;K&lt;=n;++K)&#123;</span><br><span class="line">				<span class="keyword">if</span> (n==<span class="number">9</span>&amp;&amp;K==n<span class="number">-1</span>)pend=p1;</span><br><span class="line">				<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;(<span class="number">1</span>&lt;&lt;n);++i)<span class="keyword">if</span> (<span class="built_in">pop</span>(i)==K)&#123;</span><br><span class="line">					uint add=(p10[i]+<span class="number">9</span>)%p;</span><br><span class="line">					<span class="keyword">if</span> (n==<span class="number">9</span>&amp;&amp;I==<span class="number">1</span>&amp;&amp;<span class="built_in">pop</span>(i)&lt;n<span class="number">-1</span>)<span class="keyword">continue</span>;</span><br><span class="line">					c[i]=p1; c1[i]=<span class="number">0</span>;</span><br><span class="line">					<span class="keyword">if</span> (n==<span class="number">9</span>&amp;&amp;<span class="built_in">pop</span>(i)==n<span class="number">-1</span>&amp;&amp;</span><br><span class="line">						((!I&amp;&amp;__builtin_ctz(~i)&lt;=<span class="number">4</span>)||(I&amp;&amp;__builtin_ctz(~i)&gt;<span class="number">4</span>)))<span class="keyword">continue</span>;</span><br><span class="line">					uint *_c=p1,*c0=c[i];</span><br><span class="line">					<span class="keyword">for</span> (<span class="type">int</span> j=(i<span class="number">-1</span>)&amp;i;j;j=(j<span class="number">-1</span>)&amp;i)</span><br><span class="line">						<span class="keyword">if</span> (c1[j]&lt;c1[i-j]||c1[j]==c1[i-j]&amp;&amp;j&lt;i-j)&#123;</span><br><span class="line">							<span class="keyword">if</span> (i==(<span class="number">1</span>&lt;&lt;n)<span class="number">-1</span>)&#123;</span><br><span class="line">								<span class="comment">//continue;</span></span><br><span class="line">								<span class="keyword">if</span> (I==<span class="number">1</span>&amp;&amp;<span class="built_in">pop</span>(j)!=n<span class="number">-1</span>&amp;&amp;<span class="built_in">pop</span>(i-j)!=n<span class="number">-1</span>)<span class="keyword">continue</span>;</span><br><span class="line">								<span class="keyword">for</span> (uint *I=c[j];I&lt;c[j]+c1[j];++I)&#123;</span><br><span class="line">									uint v1=*I;</span><br><span class="line">									uint t1=((ull)v1*pow10[len[i-j]+<span class="number">1</span>]+add)%p;</span><br><span class="line">									uint add1=((ull)v1*<span class="number">10</span>+add)%p,pow1=p10_[j];</span><br><span class="line">									uint r1=(ull)(r+p-t1)*pinv[<span class="number">1</span>]%p,r2=(ull)(r+p-add1)*<span class="built_in">inv</span>((<span class="type">int</span>)pow1,p)%p;</span><br><span class="line">									<span class="keyword">if</span> (r1!=r2)&#123;</span><br><span class="line">                                        uint *J=c[i-j],*end=c[i-j]+c1[i-j];</span><br><span class="line">                                        *end=r1; ++end;</span><br><span class="line">                                        <span class="keyword">for</span> (;J!=end;++ans,++J)</span><br><span class="line">                                            <span class="keyword">while</span> (*J!=r1&amp;&amp;*J!=r2)++J;</span><br><span class="line">                                        --ans;</span><br><span class="line">                                    &#125;</span><br><span class="line">									<span class="keyword">else</span> <span class="keyword">for</span> (uint *J=c[i-j],*end=c[i-j]+c1[i-j];J!=end;++J)</span><br><span class="line">										ans+=(*J==r1)+(*J==r2);</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">else</span> <span class="keyword">for</span> (uint *I=c[j];I&lt;c[j]+c1[j];++I)&#123;</span><br><span class="line">								uint v1=*I;</span><br><span class="line">								uint t1=((ull)v1*pow10[len[i-j]+<span class="number">1</span>]+add)%p;</span><br><span class="line">								uint add1=((ull)v1*<span class="number">10</span>+add)%p,pow1=p10_[j];</span><br><span class="line">								ull P2=(((u128)pow1&lt;&lt;<span class="number">64</span>)+p<span class="number">-1</span>)/p;</span><br><span class="line">								<span class="keyword">for</span> (uint *J=c[i-j],*end=c[i-j]+c1[i-j];J!=end;++J)&#123;</span><br><span class="line">									uint v2=*J;</span><br><span class="line">									*c0=(uint)(v2*P1*(u128)p&gt;&gt;<span class="number">64</span>)+t1;</span><br><span class="line">									<span class="keyword">if</span> (*c0&gt;=p)*c0-=p; ++c0;</span><br><span class="line">									*c0=(uint)(v2*P2*(u128)p&gt;&gt;<span class="number">64</span>)+add1;</span><br><span class="line">									<span class="keyword">if</span> (*c0&gt;=p)*c0-=p; ++c0;</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					c1[i]=c0-_c; c[i]=_c; p1+=c1[i]+<span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ans;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><figcaption><span>[code - 验题人的py(AC)]</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"># 算法二</span><br><span class="line">import cProfile</span><br><span class="line">import time</span><br><span class="line">from collections import *</span><br><span class="line">import itertools</span><br><span class="line">from functools import *</span><br><span class="line">from typing import *</span><br><span class="line"></span><br><span class="line">M=205</span><br><span class="line">pow10=[0]*M</span><br><span class="line">pinv=[0]*M</span><br><span class="line"># 扩展欧几里得求逆元</span><br><span class="line">def exgcd(a, b):</span><br><span class="line">    if b == 0:</span><br><span class="line">        return 1, 0, a</span><br><span class="line">    else:</span><br><span class="line">        x, y, q = exgcd(b, a % b)</span><br><span class="line">        x, y = y, (x - (a // b) * y)</span><br><span class="line">        return x, y, q</span><br><span class="line"></span><br><span class="line"># 扩展欧几里得求逆元</span><br><span class="line">@cache</span><br><span class="line">def ModReverse(a,p):</span><br><span class="line">    x, y, q = exgcd(a,p)</span><br><span class="line">    if q != 1:</span><br><span class="line">        raise Exception(&quot;No solution.&quot;)</span><br><span class="line">    else:</span><br><span class="line">        return (x + p) % p #防止负数</span><br><span class="line">@cache </span><br><span class="line">def fa(n):</span><br><span class="line">    if n==1:</span><br><span class="line">        return 1</span><br><span class="line">    res = 0</span><br><span class="line">    for i in range(1,n):</span><br><span class="line">        res += fa(i)*fa(n-i)</span><br><span class="line">    return res</span><br><span class="line"></span><br><span class="line">@cache</span><br><span class="line">def bin_num(val):</span><br><span class="line">    return val.bit_count()</span><br><span class="line">    #return bin(val).count(&#x27;1&#x27;)</span><br><span class="line"></span><br><span class="line">class Solution:</span><br><span class="line">    &#x27;&#x27;&#x27;@cache</span><br><span class="line">    def pow10(self, val, mod):</span><br><span class="line">        return pow(10, val, mod)&#x27;&#x27;&#x27;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    #@profile</span><br><span class="line">    def treeOfInfiniteSouls(self, a: List[int], p: int, r: int) -&gt; int:</span><br><span class="line">        &#x27;&#x27;&#x27;if len(a)==9:</span><br><span class="line">            if p==90007: return 5762</span><br><span class="line">            if p==2: return 518918400</span><br><span class="line">            if p==998244353: return 9&#x27;&#x27;&#x27;</span><br><span class="line">        start=time.time()</span><br><span class="line">        self.MOD = p</span><br><span class="line">        n = len(a) </span><br><span class="line">        if p==2:</span><br><span class="line">            if r==1:</span><br><span class="line">                return math.perm(n)*fa(n) </span><br><span class="line">            return 0</span><br><span class="line">        if p==5:</span><br><span class="line">            if r==4:</span><br><span class="line">                return math.perm(n)*fa(n) </span><br><span class="line">            return 0  </span><br><span class="line"></span><br><span class="line">        pow10[0]=1%p</span><br><span class="line">        for i in range(1,M): pow10[i]=pow10[i-1]*10%p</span><br><span class="line">        for i in range(M): pinv[i]=ModReverse(pow10[i],p)</span><br><span class="line"></span><br><span class="line">        max_num = 6</span><br><span class="line">        m = 1&lt;&lt;n </span><br><span class="line">        flist = defaultdict(list) # []</span><br><span class="line">        lenlist = defaultdict(int)</span><br><span class="line">        for i in range(n):</span><br><span class="line">            s = f&#x27;1&#123;a[i]&#125;9&#x27;</span><br><span class="line">            val = int(s) % self.MOD </span><br><span class="line">            flist[1&lt;&lt;i].append(val)</span><br><span class="line">            lenlist[1&lt;&lt;i] = len(s)</span><br><span class="line">        for i in range(1, m):</span><br><span class="line">            if i in flist or bin_num(i)&gt; max_num:</span><br><span class="line">                continue</span><br><span class="line">            for j in range(1,i):</span><br><span class="line">                if (j|i)^i:</span><br><span class="line">                    continue</span><br><span class="line">                len1, len2 = lenlist[j], lenlist[i-j]</span><br><span class="line">                start_val = 9 + pow10[len1+len2+1]</span><br><span class="line">                lenlist[i] = lenlist[j] + lenlist[i-j] + 2</span><br><span class="line">                bb=flist[i]</span><br><span class="line">                p0=pow10[len2+1]</span><br><span class="line">                for v1 in flist[j]:</span><br><span class="line">                    oval = start_val + v1 * p0</span><br><span class="line">                    #oval = (start_val + v1 * pow10[len2+1])%p</span><br><span class="line">                    #flist[i].extend([(oval + v2 * 10)%p for v2 in flist[i-j]])</span><br><span class="line">                    for v2 in flist[i-j]:</span><br><span class="line">                        #bb.append((start_val + v1 * p0 + v2 * 10)%p)</span><br><span class="line">                        bb.append((oval + v2 * 10)%p)</span><br><span class="line">        </span><br><span class="line">        self.numlist = &#123;k: Counter(v)  for k,v in flist.items()&#125;</span><br><span class="line">        if n &lt;= 6:</span><br><span class="line">            return self.numlist.get(m-1, &#123;&#125;).get(r, 0)</span><br><span class="line">        self.flist = flist</span><br><span class="line">        #print(&#x27;time: &#x27;,time.time() - start); start=time.time()</span><br><span class="line">        self.lenlist = lenlist </span><br><span class="line">        self.res = 0 </span><br><span class="line">        self.r = r </span><br><span class="line">        # 3, [6]  </span><br><span class="line">        self.calcs(n, 6, lambda n,x,y: True)</span><br><span class="line">        # print(self.res)</span><br><span class="line">        #print(&#x27;time1: &#x27;,time.time() - start); start=time.time()</span><br><span class="line">        # 4, [5], bro &gt;= 2</span><br><span class="line">        self.calcs(n, 5, lambda n,x,y:  x!=(1&lt;&lt;n) or bin_num(y)&gt;=2)</span><br><span class="line">        # end = time.time()</span><br><span class="line">        # print(self.res)</span><br><span class="line">        #print(&#x27;time2: &#x27;,time.time() - start); start=time.time()</span><br><span class="line">        # # 5, [4], bro &gt;= 3 and &lt;= 4 </span><br><span class="line">        self.calcs(n, 4, lambda n,x,y:  x!=(1&lt;&lt;n) or bin_num(y) in (3,4))</span><br><span class="line">        # end = time.time()</span><br><span class="line">        # print(self.res)</span><br><span class="line">        #print(&#x27;time3: &#x27;,time.time() - start); start=time.time()</span><br><span class="line">        return self.res </span><br><span class="line"></span><br><span class="line">    #@profile</span><br><span class="line">    def calcs(self, n, num, check_func):</span><br><span class="line">        #_pow10=pow10.copy()</span><br><span class="line">        pow10[0]=1%self.MOD</span><br><span class="line">        for i in range(1,M): pow10[i]=pow10[i-1]*10%self.MOD</span><br><span class="line">        t0=time.time()</span><br><span class="line">        # 选择 num 个点合并组成 sub</span><br><span class="line">        # n-num 个点 + sub 构成完整的树 </span><br><span class="line">        #g = defaultdict(list)</span><br><span class="line">        g=[[] for i in range(1&lt;&lt;(n+1))]</span><br><span class="line">        g[1&lt;&lt;n] = [[0,0,0,0]]</span><br><span class="line">        count_res = 0</span><br><span class="line">        for k in range((1&lt;&lt;n)+1 , 1&lt;&lt;(n+1)): # 最高位表示有 sub 点</span><br><span class="line">            one_num = bin_num(k)</span><br><span class="line">            if one_num &gt; n - num + 1:</span><br><span class="line">                continue</span><br><span class="line"></span><br><span class="line">            i = (k-1)&amp;k</span><br><span class="line">            while i&gt;=(1&lt;&lt;n):</span><br><span class="line">                j = k-i</span><br><span class="line">                if not check_func(n, i, j):</span><br><span class="line">                    i = (i-1)&amp;k</span><br><span class="line">                    continue </span><br><span class="line">                # print(k,i,j, bin(k), bin(i), bin(j), len(g[i]))</span><br><span class="line">                # input()</span><br><span class="line">                L=self.lenlist[j]</span><br><span class="line">                for l,r, llen, rlen in g[i]:</span><br><span class="line">                    #l,r, llen, rlen = info </span><br><span class="line">                    xnewl = pow10[llen] + l  </span><br><span class="line">                    xnewr = 9 + r * pow10[self.lenlist[j]+1]# % self.MOD</span><br><span class="line">                    ynewl = l + pow10[self.lenlist[j]+llen]</span><br><span class="line">                    ynewr = 9 + r * 10</span><br><span class="line">                    cc=[xnewl, 0, llen+1, rlen+L+1]</span><br><span class="line">                    p0=pow10[llen]</span><br><span class="line">                    l0=llen+self.lenlist[j]+1</span><br><span class="line">                    ee=[0, ynewr, l0, rlen+1]</span><br><span class="line">                    for v in self.flist[j]:</span><br><span class="line">                        # 1 i j 9</span><br><span class="line">                        dd=cc.copy()</span><br><span class="line">                        dd[1]=(xnewr + v*10)%self.MOD</span><br><span class="line">                        g[k].append(dd)</span><br><span class="line">                        #g[k].append([xnewl, (xnewr + v*10)%self.MOD, llen+1, rlen+self.lenlist[j]+1])</span><br><span class="line">                        </span><br><span class="line">                        # 1 j i 1</span><br><span class="line">                    if i!=(1&lt;&lt;n) or num != 4 or j.bit_count() != 4: # 防止出现 4 - 4 重复， 注意加特殊用例</span><br><span class="line">                        for v in self.flist[j]:</span><br><span class="line">                            #newl = (ynewl + v*p0 ) % self.MOD</span><br><span class="line">                            ff=ee.copy()</span><br><span class="line">                            ff[0]=(ynewl + v*p0 ) % self.MOD</span><br><span class="line">                            g[k].append(ff)</span><br><span class="line">                            #g[k].append([newl, ynewr, l0, rlen+1])</span><br><span class="line">                i = (i-1)&amp;k</span><br><span class="line">            if one_num == n - num + 1:</span><br><span class="line">                count_res += len(g[k])</span><br><span class="line">                lm = k^((1&lt;&lt;(n+1)) -1)</span><br><span class="line">                xlen = self.lenlist[lm]</span><br><span class="line">                if lm in self.numlist:</span><br><span class="line">                    aa=self.numlist[lm]</span><br><span class="line">                    for x,y,_,w in g[k]:</span><br><span class="line">                        # l,r, llen,rlen = info </span><br><span class="line">                        # l x r</span><br><span class="line">                        #tmp = </span><br><span class="line">                        #if tmp in aa: self.res += aa[tmp]</span><br><span class="line">                        self.res += aa.get((self.r - x* pow10[xlen+w] - y) * pinv[w] % self.MOD ,0)</span><br><span class="line">        #print(&#x27;calc time=&#x27;,time.time()-t0)</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><figcaption><span>[code - 验题人的py(TLE)]</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 算法三</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">treeOfInfiniteSouls</span>(<span class="params">self, a: <span class="type">List</span>[<span class="built_in">int</span>], p: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        self.MOD = p</span><br><span class="line">        n = <span class="built_in">len</span>(a)</span><br><span class="line">        lnum = n//<span class="number">2</span></span><br><span class="line">        rnum = n-lnum</span><br><span class="line">        ways = self.sea(n) </span><br><span class="line">        res = <span class="number">0</span> </span><br><span class="line">        <span class="keyword">for</span> way <span class="keyword">in</span> ways:</span><br><span class="line">            tmp, tidx = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> idx, i <span class="keyword">in</span> <span class="built_in">enumerate</span>(way):</span><br><span class="line">                <span class="keyword">if</span> i==<span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                    tmp += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> tmp == lnum:</span><br><span class="line">                    tidx = idx</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            ls, rs = way[:tidx+<span class="number">1</span>], way[tidx+<span class="number">1</span>:]</span><br><span class="line">            <span class="keyword">for</span> xlist <span class="keyword">in</span> itertools.combinations(a, lnum):</span><br><span class="line">                xcount = Counter(xlist)</span><br><span class="line">                ylist = []</span><br><span class="line">                ylen = <span class="built_in">len</span>(rs) - rnum * <span class="number">2</span></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">                    <span class="keyword">if</span> xcount[i] &gt; <span class="number">0</span>:</span><br><span class="line">                        xcount[i] -= <span class="number">1</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        ylen += <span class="built_in">len</span>(<span class="built_in">str</span>(i))</span><br><span class="line">                        ylist.append(i)</span><br><span class="line">                xtmp = <span class="built_in">pow</span>(<span class="number">10</span>, ylen, self.MOD)</span><br><span class="line">                xdict = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">                <span class="keyword">for</span> new_xlist <span class="keyword">in</span> itertools.permutations(xlist, lnum):</span><br><span class="line">                    xmod = self.get_val(ls, new_xlist)</span><br><span class="line">                    xval =  xmod * xtmp % self.MOD  </span><br><span class="line">                    xdict[xval] += <span class="number">1</span></span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">for</span> new_ylist <span class="keyword">in</span> itertools.permutations(ylist, rnum):</span><br><span class="line">                    ymod = self.get_val(rs, new_ylist)</span><br><span class="line">                    yval = (r-ymod)% self.MOD</span><br><span class="line">                    res += xdict[yval]</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_val</span>(<span class="params">self, s, vlist</span>):</span><br><span class="line">        val = s.<span class="built_in">format</span>(*vlist)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(val)%self.MOD</span><br><span class="line"></span><br><span class="line"><span class="meta">    @cache</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sea</span>(<span class="params">self, n</span>):</span><br><span class="line">        <span class="keyword">if</span> n==<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> [<span class="string">&#x27;1&#123;&#125;9&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,n):</span><br><span class="line">            llist, rlist = self.sea(i), self.sea(n-i)</span><br><span class="line">            <span class="keyword">for</span> l <span class="keyword">in</span> llist:</span><br><span class="line">                <span class="keyword">for</span> r <span class="keyword">in</span> rlist:</span><br><span class="line">                    res.append(<span class="string">f&#x27;1<span class="subst">&#123;l&#125;</span><span class="subst">&#123;r&#125;</span>9&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><figcaption><span>[code - 暴力DP(TLE)]</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">10</span>,M=<span class="number">205</span>;</span><br><span class="line"><span class="type">int</span> pow10[M],l[N],len[<span class="number">1</span>&lt;&lt;N],ans;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">log10</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;<span class="keyword">return</span> n&lt;<span class="number">10</span>?<span class="number">1</span>:<span class="built_in">log10</span>(n/<span class="number">10</span>)+<span class="number">1</span>;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">treeOfInfiniteSouls</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; a,<span class="type">int</span> p,<span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">		<span class="type">int</span> n=a.<span class="built_in">size</span>();</span><br><span class="line">		<span class="comment">//if (n==9)return p==90007?5762:(p==2?518918400:9);</span></span><br><span class="line">		pow10[<span class="number">0</span>]=<span class="number">1</span>%p; <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;M;++i)pow10[i]=(ll)pow10[i<span class="number">-1</span>]*<span class="number">10</span>%p;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;++i)l[i]=<span class="built_in">log10</span>(a[i]);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;(<span class="number">1</span>&lt;&lt;n);++i)&#123;</span><br><span class="line">			len[i]=(__builtin_popcount(i)*<span class="number">2</span><span class="number">-1</span>)*<span class="number">2</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">0</span>;j&lt;n;++j)<span class="keyword">if</span> (i&amp;(<span class="number">1</span>&lt;&lt;j))len[i]+=l[j];</span><br><span class="line">		&#125;</span><br><span class="line">		vector&lt;<span class="type">int</span>&gt; c[<span class="number">1</span>&lt;&lt;N];</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;++i)c[<span class="number">1</span>&lt;&lt;i].<span class="built_in">push_back</span>(((ll)a[i]*<span class="number">10</span>+pow10[l[i]+<span class="number">1</span>]+<span class="number">9</span>)%p);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;(<span class="number">1</span>&lt;&lt;n);++i)</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> j=(i<span class="number">-1</span>)&amp;i;j;j=(j<span class="number">-1</span>)&amp;i)</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;v1:c[j])&#123;</span><br><span class="line">					ll t1=pow10[len[i]<span class="number">-1</span>]+<span class="number">9</span>+(ll)v1*pow10[len[i-j]+<span class="number">1</span>];</span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;v2:c[i-j])</span><br><span class="line">						c[i].<span class="built_in">push_back</span>(((ll)v2*<span class="number">10</span>+t1)%p);</span><br><span class="line">				&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">count</span>(c[(<span class="number">1</span>&lt;&lt;n)<span class="number">-1</span>].<span class="built_in">begin</span>(),c[(<span class="number">1</span>&lt;&lt;n)<span class="number">-1</span>].<span class="built_in">end</span>(),r);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><figcaption><span>[code - 暴力dfs(TLE)]</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> M=<span class="number">205</span>;</span><br><span class="line"><span class="type">int</span> pow10[M],ans,p,r,S;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">node</span>&#123;</span><br><span class="line">	<span class="type">int</span> v,l;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">log10</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> res=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (n&gt;=<span class="number">10</span>)++res,n/=<span class="number">10</span>;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(vector&lt;node&gt; &amp;a,<span class="type">int</span> minj)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (a.<span class="built_in">size</span>()==<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span> (a[<span class="number">0</span>].v==r)++ans;</span><br><span class="line">		++S;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j=minj;j&lt;a.<span class="built_in">size</span>();++j)</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;j;++i)&#123;</span><br><span class="line">			vector&lt;node&gt; a1=a;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> k=i;k&lt;j<span class="number">-1</span>;++k)a1[k]=a1[k+<span class="number">1</span>];</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> k=j<span class="number">-1</span>;k&lt;a.<span class="built_in">size</span>()<span class="number">-2</span>;++k)a1[k]=a1[k+<span class="number">2</span>]; a1.<span class="built_in">pop_back</span>();</span><br><span class="line">			<span class="type">int</span> l=a[i].l+a[j].l+<span class="number">2</span>;</span><br><span class="line">			a1[a1.<span class="built_in">size</span>()<span class="number">-1</span>]=&#123;((ll)a[i].v*pow10[a[j].l+<span class="number">1</span>]+(ll)a[j].v*<span class="number">10</span>+pow10[l<span class="number">-1</span>]+<span class="number">9</span>)%p,l&#125;;</span><br><span class="line">			<span class="built_in">dfs</span>(a1,j<span class="number">-1</span>);</span><br><span class="line">			a1[a1.<span class="built_in">size</span>()<span class="number">-1</span>]=&#123;((ll)a[j].v*pow10[a[i].l+<span class="number">1</span>]+(ll)a[i].v*<span class="number">10</span>+pow10[l<span class="number">-1</span>]+<span class="number">9</span>)%p,l&#125;;</span><br><span class="line">			<span class="built_in">dfs</span>(a1,j<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">treeOfInfiniteSouls</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; a,<span class="type">int</span> p,<span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">		<span class="type">int</span> n=a.<span class="built_in">size</span>(); ans=<span class="number">0</span>; ::p=p; ::r=r;</span><br><span class="line">		pow10[<span class="number">0</span>]=<span class="number">1</span>%p; <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>;i&lt;M;++i)pow10[i]=(ll)pow10[i<span class="number">-1</span>]*<span class="number">10</span>%p;</span><br><span class="line">		<span class="function">vector&lt;node&gt; <span class="title">c</span><span class="params">(n)</span></span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;++i)</span><br><span class="line">			c[i].l=<span class="built_in">log10</span>(a[i])+<span class="number">2</span>,c[i].v=((ll)a[i]*<span class="number">10</span>+pow10[c[i].l<span class="number">-1</span>]+<span class="number">9</span>)%p;</span><br><span class="line">		<span class="built_in">dfs</span>(c,<span class="number">1</span>);</span><br><span class="line">		<span class="comment">//printf(&quot;S=%d\n&quot;,S);</span></span><br><span class="line">		<span class="keyword">return</span> ans;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

        </div>

        
            <div class="post-copyright-info">
                <!--<div class="article-copyright-info-container">-->
    <!--&lt;!&ndash;<ul>&ndash;&gt;-->
        <!--&lt;!&ndash;<li><strong>Title:</strong> LCP 82-万灵之树</li>&ndash;&gt;-->
        <!--&lt;!&ndash;<li><strong>Author:</strong> Raphael Liu</li>&ndash;&gt;-->
        <!--&lt;!&ndash;<li><strong>Created at&ndash;&gt;-->
                <!--&lt;!&ndash;:</strong> 2023-09-13 00:47:26</li>&ndash;&gt;-->
        <!--&lt;!&ndash;&ndash;&gt;-->
            <!--&lt;!&ndash;<li>&ndash;&gt;-->
                <!--&lt;!&ndash;<strong>Updated at&ndash;&gt;-->
                    <!--&lt;!&ndash;:</strong> 2023-09-13 17:01:06&ndash;&gt;-->
            <!--&lt;!&ndash;</li>&ndash;&gt;-->
        <!--&lt;!&ndash;&ndash;&gt;-->
        <!--&lt;!&ndash;&lt;!&ndash;<li>&ndash;&gt;&ndash;&gt;-->
            <!--&lt;!&ndash;&lt;!&ndash;<strong>Link:</strong> https://fida.ltd/2023/09/13/LCP 82-万灵之树/&ndash;&gt;&ndash;&gt;-->
        <!--&lt;!&ndash;&lt;!&ndash;</li>&ndash;&gt;&ndash;&gt;-->
        <!--&lt;!&ndash;&lt;!&ndash;<li>&ndash;&gt;&ndash;&gt;-->
            <!--&lt;!&ndash;&lt;!&ndash;<strong>&ndash;&gt;&ndash;&gt;-->
                <!--&lt;!&ndash;&lt;!&ndash;License:&ndash;&gt;&ndash;&gt;-->
            <!--&lt;!&ndash;&lt;!&ndash;</strong>&ndash;&gt;&ndash;&gt;-->
            <!--&lt;!&ndash;&lt;!&ndash;&ndash;&gt;&ndash;&gt;-->
            <!--&lt;!&ndash;&lt;!&ndash;This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a>.&ndash;&gt;&ndash;&gt;-->
            <!--&lt;!&ndash;&lt;!&ndash;&ndash;&gt;&ndash;&gt;-->

        <!--&lt;!&ndash;&lt;!&ndash;</li>&ndash;&gt;&ndash;&gt;-->
    <!--&lt;!&ndash;</ul>&ndash;&gt;-->
<!--</div>-->

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/algorithm/">#algorithm</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/HARD/">#HARD</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                        rel="prev"
                        href="/2023/09/13/LCR%20003-%E6%AF%94%E7%89%B9%E4%BD%8D%E8%AE%A1%E6%95%B0/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">LCR 003-比特位计数</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                        rel="next"
                        href="/2023/09/13/LCR%20004-%E5%8F%AA%E5%87%BA%E7%8E%B0%E4%B8%80%E6%AC%A1%E7%9A%84%E6%95%B0%E5%AD%97%20II/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">LCR 004-只出现一次的数字 II</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container">
                <div class="comments-container pjax">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fa-solid fa-comments"></i>&nbsp;Comments
    </div>
    

        
            
 
    <div id="waline"></div>
    <script type="module"  data-swup-reload-script>
        import { init } from 'https://evan.beee.top/js/waline.mjs';

        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://example.example.com',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
            });
        }

        if ('true') {
            const loadWalineTimeout = setTimeout(() => {
                loadWaline();
                clearTimeout(loadWalineTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadWaline);
        }
        
    </script>



        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">LCP 82-万灵之树</div>
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E8%A7%A3"><span class="nav-text">题解</span></a></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Raphael Liu</a>
        </div>
        
            <script data-swup-reload-script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">UV:</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">PV:</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <!--<div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">-->
            <!--<span class="lg:block text-sm">powered_by</span>-->
            <!--&lt;!&ndash;<span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.4.4</a></span>&ndash;&gt;-->
        <!--</div>-->
        
        <!---->
            <!--<div>-->
                <!--runtime <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hours <span class="odometer" id="runtime_minutes"></span> minutes <span class="odometer" id="runtime_seconds"></span> seconds-->
            <!--</div>-->
        <!---->
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        

    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex justify-center items-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
        ],
        containers: ["#swup"],
    });

    swup.hooks.on("page:view", () => {
        Global.refresh();
    });

    // if (document.readyState === "complete") {
    //
    // } else {
    //     document.addEventListener("DOMContentLoaded", () => init());
    // }
</script>






<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>



    
<script src="/js/tools/localSearch.js"></script>




    
<script src="/js/tools/codeBlock.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>







<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/libs/anime.min.js"></script>

        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
